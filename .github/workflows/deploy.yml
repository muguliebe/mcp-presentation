name: Deploy to GitHub Pages

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

# GitHub Pages ë°°í¬ë¥¼ ìœ„í•œ ê¶Œí•œ ì„¤ì •
permissions:
  contents: read
  pages: write
  id-token: write

# ë™ì‹œ ë°°í¬ ë°©ì§€
concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  # ë¹Œë“œ ë° í…ŒìŠ¤íŠ¸ ì‘ì—…
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        
    - name: Install dependencies
      run: |
        npm ci || npm install
        
    - name: Lint code
      run: |
        # í”„ë ˆì  í…Œì´ì…˜ íŒŒì¼ì˜ ê¸°ë³¸ ê²€ì¦
        echo "Validating HTML structure..."
        if [ -f "index.html" ]; then
          echo "âœ“ index.html found"
        else
          echo "âœ— index.html not found"
          exit 1
        fi
        
        echo "Validating CSS files..."
        if [ -f "assets/css/custom.css" ]; then
          echo "âœ“ custom.css found"
        else
          echo "âœ— custom.css not found"
          exit 1
        fi
        
        echo "Validating JavaScript files..."
        if [ -f "assets/js/custom.js" ]; then
          echo "âœ“ custom.js found"
        else
          echo "âœ— custom.js not found"
          exit 1
        fi
        
    - name: Validate presentation structure
      run: |
        echo "Validating presentation content..."
        
        # HTML êµ¬ì¡° ê²€ì¦
        if grep -q "reveal" index.html; then
          echo "âœ“ Reveal.js structure found"
        else
          echo "âœ— Reveal.js structure not found"
          exit 1
        fi
        
        # í•„ìˆ˜ ì„¹ì…˜ í™•ì¸
        if grep -q "MCP" index.html; then
          echo "âœ“ MCP content found"
        else
          echo "âœ— MCP content not found"
          exit 1
        fi
        
        # Mermaid ë‹¤ì´ì–´ê·¸ë¨ í™•ì¸
        if grep -q "mermaid" index.html; then
          echo "âœ“ Mermaid diagrams found"
        else
          echo "âœ— Mermaid diagrams not found"
          exit 1
        fi
        
    - name: Test code samples
      run: |
        echo "Validating code samples..."
        
        # ì½”ë“œ ìƒ˜í”Œ íŒŒì¼ ì¡´ì¬ í™•ì¸
        for file in code-samples/*.js; do
          if [ -f "$file" ]; then
            echo "âœ“ Found: $file"
            # ê¸°ë³¸ JavaScript ë¬¸ë²• ê²€ì¦
            node -c "$file" && echo "âœ“ $file syntax valid" || echo "âœ— $file has syntax errors"
          fi
        done
        
    - name: Setup Pages
      if: github.ref == 'refs/heads/main'
      uses: actions/configure-pages@v5
      
    - name: Build presentation
      run: |
        echo "Building presentation for GitHub Pages..."
        
        # í”„ë¡œë•ì…˜ìš© ì„¤ì •
        echo "Optimizing assets..."
        
        # CSS ìµœì†Œí™” (ê¸°ë³¸ì ì¸ ì²˜ë¦¬)
        if command -v cleancss >/dev/null 2>&1; then
          cleancss -o assets/css/custom.min.css assets/css/custom.css
          echo "âœ“ CSS minified"
        else
          cp assets/css/custom.css assets/css/custom.min.css
          echo "â„¹ CSS copied (cleancss not available)"
        fi
        
        # ì´ë¯¸ì§€ ìµœì í™” ë””ë ‰í„°ë¦¬ í™•ì¸
        mkdir -p assets/images
        
        # QR ì½”ë“œ ìƒì„± (í”„ë ˆì  í…Œì´ì…˜ URLìš©)
        echo "Generating QR code for presentation..."
        # ì‹¤ì œ ë°°í¬ ì‹œì—ëŠ” ì‹¤ì œ URLë¡œ ëŒ€ì²´
        PAGES_URL="https://${{ github.repository_owner }}.github.io/mcp-presentation"
        echo "QR Code will point to: $PAGES_URL"
        
        # ë¹Œë“œ ì •ë³´ íŒŒì¼ ìƒì„±
        echo "{
          \"build_time\": \"$(date -u +%Y-%m-%dT%H:%M:%SZ)\",
          \"commit_hash\": \"${{ github.sha }}\",
          \"branch\": \"${{ github.ref_name }}\",
          \"pages_url\": \"$PAGES_URL\"
        }" > build-info.json
        
    - name: Upload Pages artifact
      if: github.ref == 'refs/heads/main'
      uses: actions/upload-pages-artifact@v3
      with:
        path: .

  # GitHub Pages ë°°í¬ ì‘ì—…
  deploy:
    if: github.ref == 'refs/heads/main'
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    needs: build
    
    steps:
    - name: Deploy to GitHub Pages
      id: deployment
      uses: actions/deploy-pages@v4
      
    - name: Comment PR with deployment info
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v7
      with:
        script: |
          const deploymentUrl = '${{ steps.deployment.outputs.page_url }}';
          const body = `ğŸš€ **Deployment successful!**
          
          Your presentation is now live at: ${deploymentUrl}
          
          ğŸ“± **Mobile Access**: The presentation is optimized for iPad and mobile devices.
          ğŸ”— **QR Code**: Available on the title slide for easy access.
          
          **Features included:**
          - âœ… Reveal.js presentation framework
          - âœ… Mermaid diagrams for architecture
          - âœ… Syntax-highlighted code samples
          - âœ… Mobile-friendly design
          - âœ… Interactive navigation
          
          **Sections:**
          1. ğŸ¯ Hook: AI automatic error solutions
          2. ğŸ“– MCP Introduction (5 min)
          3. ğŸ—ï¸ Project Architecture (10 min)  
          4. ğŸ¬ Live Demo (10 min)
          5. âš™ï¸ Technical Implementation (10 min)
          6. â“ Q&A (5 min)`;
          
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: body
          });

  # ì½”ë“œ í’ˆì§ˆ ê²€ì‚¬
  quality-check:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        
    - name: Install quality tools
      run: |
        npm install -g htmlhint jshint markdownlint-cli
        
    - name: Check HTML quality
      run: |
        echo "Checking HTML quality..."
        htmlhint index.html || echo "HTML hints completed"
        
    - name: Check JavaScript quality  
      run: |
        echo "Checking JavaScript quality..."
        for file in assets/js/*.js code-samples/*.js; do
          if [ -f "$file" ]; then
            echo "Checking: $file"
            jshint "$file" || echo "JSHint completed for $file"
          fi
        done
        
    - name: Check Markdown quality
      run: |
        echo "Checking Markdown quality..."
        if [ -f "README.md" ]; then
          markdownlint README.md || echo "Markdown lint completed"
        fi
        
        if [ -f "diagrams/architecture-flow.md" ]; then
          markdownlint diagrams/architecture-flow.md || echo "Markdown lint completed"
        fi
        
    - name: Accessibility check
      run: |
        echo "Basic accessibility checks..."
        
        # alt íƒœê·¸ í™•ì¸
        if grep -n "<img" index.html | grep -v "alt="; then
          echo "âš ï¸ Images without alt attributes found"
        else
          echo "âœ“ All images have alt attributes"
        fi
        
        # ì œëª© êµ¬ì¡° í™•ì¸
        if grep -q "<h1>" index.html && grep -q "<h2>" index.html; then
          echo "âœ“ Proper heading structure found"
        else
          echo "âš ï¸ Check heading structure"
        fi
        
    - name: Performance hints
      run: |
        echo "Performance optimization hints..."
        
        # ì´ë¯¸ì§€ í¬ê¸° í™•ì¸
        if [ -d "assets/images" ]; then
          find assets/images -name "*.png" -o -name "*.jpg" -o -name "*.jpeg" | while read img; do
            size=$(stat -f%z "$img" 2>/dev/null || stat -c%s "$img" 2>/dev/null || echo "0")
            if [ "$size" -gt 1048576 ]; then # 1MB
              echo "âš ï¸ Large image detected: $img ($size bytes)"
            fi
          done
        fi
        
        # CSS/JS íŒŒì¼ í¬ê¸° í™•ì¸
        for file in assets/css/*.css assets/js/*.js; do
          if [ -f "$file" ]; then
            size=$(stat -f%z "$file" 2>/dev/null || stat -c%s "$file" 2>/dev/null || echo "0")
            if [ "$size" -gt 102400 ]; then # 100KB
              echo "âš ï¸ Large asset file: $file ($size bytes)"
            fi
          fi
        done

  # ë³´ì•ˆ ê²€ì‚¬
  security-check:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Security scan
      run: |
        echo "Running security checks..."
        
        # ë¯¼ê°í•œ ì •ë³´ í™•ì¸
        echo "Checking for sensitive information..."
        
        # API í‚¤ íŒ¨í„´ ê²€ì‚¬
        if grep -r -E "(api[_-]?key|secret|password|token)" --include="*.js" --include="*.html" --include="*.css" . | grep -v "example\|placeholder\|demo"; then
          echo "âš ï¸ Potential sensitive information found"
        else
          echo "âœ“ No sensitive information detected"
        fi
        
        # í•˜ë“œì½”ë”©ëœ URL í™•ì¸
        if grep -r -E "http://localhost|127\.0\.0\.1" --include="*.js" --include="*.html" . | grep -v "comment\|example"; then
          echo "âš ï¸ Localhost URLs found in code"
        else
          echo "âœ“ No localhost URLs in production code"
        fi
        
        # ì•…ì„± ìŠ¤í¬ë¦½íŠ¸ íŒ¨í„´ í™•ì¸
        if grep -r -E "(eval\s*\(|document\.write|innerHTML\s*=)" --include="*.js" . | grep -v "comment\|//"; then
          echo "âš ï¸ Potentially unsafe JavaScript patterns found"
        else
          echo "âœ“ No unsafe JavaScript patterns detected"
        fi
        
    - name: Dependency security check
      run: |
        if [ -f "package.json" ]; then
          echo "Checking npm dependencies..."
          npm audit || echo "npm audit completed"
        else
          echo "No package.json found, skipping dependency check"
        fi